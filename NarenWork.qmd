---
title: "NarenWork"
author: "Naren Prakash"
format: pdf
editor: visual
---

```{r}
library(tidyverse)
library(tidytext)
library(stringr)
library(pdftools)
library(syuzhet)
library(textdata)
library(readtext)
library(tm)
library(quanteda)
library(Rgraphviz)
library(topicmodels)
library(gridExtra)
```

```{r}
library(doParallel)
ncores <- detectCores()
clus <- makeCluster(ncores - 1)
registerDoParallel(clus)
```

```{r}
movies <- read_csv("movie_texts_tf_idf.csv")
```

## LDA

```{r}
mov <- movies %>% cast_dtm(title, word, n)
mov_LDA <- LDA(mov, k = 4, control = list(seed = 133))

topics <- tidy(mov_LDA, matrix = "beta")

topterms <- topics %>%
  group_by(topic) %>%
  top_n(10, beta) %>%
  ungroup() %>%
  arrange(topic, -beta)
topterms %>%
  mutate(term = reorder_within(term, beta, topic)) %>%
  ggplot(aes(term,
    beta,
    fill = factor(topic)
  )) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~topic,
    scales =
      "free"
  ) +
  coord_flip() +
  scale_x_reordered() + theme_minimal() + ggtitle("10 most frequent terms by LDA topic group") + scale_fill_brewer(palette = "Pastel2")
```

```{r}
titleandyear <- movies %>% mutate(document = title) %>% select(c(document, decade))
docs <- tidy(mov_LDA, matrix = "gamma")
docs <- docs %>% inner_join(titleandyear)
docs$decade <- as.factor(docs$decade)
docs %>%
  mutate(document = reorder(document, gamma)) %>%
  ggplot(aes(factor(topic), gamma, fill = as.factor(topic))) +
  geom_boxplot() +
  facet_wrap(~decade) + xlab("Topic") + scale_fill_brewer(palette = "Pastel1") + theme_minimal() + labs(fill = "Topic colors") + ggtitle("Box plots of gamma value by topics")
```

## Classification model

.

```{r}
texts <- read_csv("cleaned_text_decade.csv") %>% select(title, decade, text)
texts$text <- gsub(pattern = '[[:punct:]]', replacement = '', texts$text)
corp <- Corpus(VectorSource(texts$text))
corp <- tm_map(corp, removePunctuation)
dtm <- DocumentTermMatrix(corp)
dtm <- removeSparseTerms(dtm, 0.96)
```

```{r}
data <- as.data.frame(as.matrix(dtm), stringsAsFactors=False)
data$decade <- texts$decade

print(table(data$decade))
prop.table(table(data$decade))
```

```{r}
library(randomForest)
set.seed(133)

num <- floor(0.7 * nrow(data))

train_ind <- sample(seq_len(nrow(data)), size  = num)
train <- data[train_ind, ]
test <- data[-train_ind, ]

print(dim(train))
print(dim(test))
```

```{r}
model <- randomForest(decade ~ ., train)
predictions <- predict(model, newdata = test)
trainp <- predict(model, newdata = train)
```